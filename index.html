<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Retrospectives on drug discovery</title>
<style>
  /* Layout */
  body { margin:0; font-family: system-ui, Arial, sans-serif; display:flex; height:100vh; }
  nav { width: clamp(220px, 28vw, 360px); max-width:100%; border-right:1px solid #ddd; padding:12px; box-sizing:border-box; background:#fff; overflow:auto; }
  main { flex:1; min-width:0; overflow:auto; padding:20px; box-sizing:border-box; }

  /* Controls */
  .controls { display:flex; gap:8px; margin-bottom:12px; align-items:center; }
  .sel { display:flex; flex-direction:column; gap:6px; }
  .sel button.current { display:flex; justify-content:space-between; align-items:center; padding:8px 10px; border-radius:8px; border:1px solid #cfcfcf; background:#fff; cursor:pointer; }
  .menu { position:relative; }
  .menu-list { position:absolute; left:0; right:0; max-height:220px; overflow:auto; border:1px solid #ddd; background:white; margin-top:6px; border-radius:8px; box-shadow:0 6px 16px rgba(0,0,0,0.06); z-index:40; }
  .menu-list button { display:block; width:100%; padding:8px 10px; text-align:left; border:0; background:transparent; cursor:pointer; }
  .menu-list button[aria-selected="true"] { background:#f2f6ff; }

  /* Months row (wrap on small) */
  .months { display:flex; flex-wrap:wrap; gap:6px; }
  .month-btn { padding:6px 8px; border-radius:6px; border:1px solid #ddd; background:white; cursor:pointer; font-size:0.95em; }
  .month-btn[aria-pressed="true"] { background:#eef3ff; border-color:#b7c6ff; font-weight:600; }

  /* Article list */
  .item { display:block; padding:8px; border-radius:6px; text-decoration:none; color:inherit; margin-bottom:6px; }
  .date { font-size:0.9em; color:#444; display:block; }
  .score-badge { display:inline-block; padding:3px 6px; border-radius:4px; font-weight:600; margin-right:8px; }

  /* Small screens */
  @media (max-width:600px) {
    body { flex-direction:column; height:auto; }
    nav { width:100%; max-height:120px; overflow:hidden; transition:max-height .26s ease, box-shadow .18s ease; border-right:none; border-bottom:1px solid #ddd; }
    nav.expanded { max-height:80vh; overflow:auto; box-shadow:0 6px 16px rgba(0,0,0,0.06); }
    .nav-peek-handle { position:absolute; right:12px; top:12px; z-index:3; padding:6px 8px; font-size:13px; border-radius:6px; border:1px solid #ccc; background:white; cursor:pointer; }
    nav::after { content:""; position:absolute; left:0; right:0; bottom:0; height:36px; pointer-events:none; background:linear-gradient(rgba(255,255,255,0), rgba(255,255,255,1)); }
  }

  /* Accessibility focus styles */
  .nav-peek-handle:focus, .menu-list button:focus, .month-btn:focus, a.item:focus { outline:2px solid Highlight; outline-offset:2px; }
</style>
</head>
<body>

  <nav id="sidebar" aria-label="Articles">
    <div style="position:relative">
      <button class="nav-peek-handle" id="peekHandle" aria-expanded="false" title="Menu">Menu</button>
      <h2 style="margin:0 0 8px 0">Articles</h2>
    </div>

    <div class="controls" id="controls">
      <div class="sel" id="yearSel">
        <label for="yearButton" style="font-size:0.85em;color:#333">Year</label>
        <div class="menu">
          <button id="yearButton" class="current" aria-haspopup="listbox" aria-expanded="false">—</button>
          <div id="yearList" class="menu-list" role="listbox" tabindex="-1" hidden></div>
        </div>
      </div>

      <div class="sel" id="monthSel">
        <label style="font-size:0.85em;color:#333">Month</label>
        <div class="months" id="monthsRow" role="toolbar" aria-label="Months"></div>
      </div>
    </div>

    <div id="list" aria-live="polite"></div>
  </nav>

  <main id="content">
    <p>Select an article</p>
  </main>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
/* Lightweight archive UI: year + month navigation, month-list rendering only (for performance).
   Expects index.json to be an array of { filename, title, date (YYYY-MM-DD or YYYYMMDD), score }.
*/

const monthsNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const listEl = document.getElementById('list');
const contentEl = document.getElementById('content');
const yearButton = document.getElementById('yearButton');
const yearList = document.getElementById('yearList');
const monthsRow = document.getElementById('monthsRow');
const peekHandle = document.getElementById('peekHandle');
const sidebar = document.getElementById('sidebar');

let indexData = [];
let grouped = {}; // { year: { monthIndex: [items] } }
let years = [];
let selectedYear = null;
let selectedMonth = null; // 0-based
const articleCache = new Map();

function parseDateParts(d) {
  if (!d) return null;
  const s = String(d);
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return { year: +s.slice(0,4), month: +s.slice(5,7), day: +s.slice(8,10) };
  if (/^\d{8}$/.test(s)) return { year:+s.slice(0,4), month:+s.slice(4,6), day:+s.slice(6,8) };
  return null;
}

function formatDate(d) {
  const p = parseDateParts(d);
  if (!p) return '';
  const m = String(p.month).padStart(2,'0');
  const day = String(p.day).padStart(2,'0');
  return `${p.year}-${m}-${day}`;
}

function createItemNode(item) {
  const a = document.createElement('a');
  a.href = '#'+item.filename;
  a.className = 'item';
  a.dataset.filename = item.filename;
  const hue = (item.score || 0) * 13;
  const badge = `<span class="score-badge" style="background:hsl(${hue},70%,75%)">${item.score||0}</span>`;
  a.innerHTML = badge + '<strong>' + escapeHtml(item.title) + '</strong><span class="date">' + formatDate(item.date) + '</span>';
  return a;
}

function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function renderMonthList(year, monthIndex) {
  listEl.innerHTML = '';
  if (!grouped[year] || !grouped[year][monthIndex] || grouped[year][monthIndex].length === 0) {
    listEl.innerHTML = '<p>No articles for this month.</p>';
    return;
  }
  const frag = document.createDocumentFragment();
  grouped[year][monthIndex].forEach(it => frag.appendChild(createItemNode(it)));
  listEl.appendChild(frag);
}

function populateYearList() {
  yearList.innerHTML = '';
  years.forEach(y => {
    const btn = document.createElement('button');
    btn.textContent = y;
    btn.setAttribute('role','option');
    btn.tabIndex = 0;
    btn.addEventListener('click', () => { selectYear(y); toggleYearMenu(false); });
    yearList.appendChild(btn);
  });
}

function populateMonthsRow() {
  monthsRow.innerHTML = '';
  monthsNames.forEach((m, i) => {
    const b = document.createElement('button');
    b.className = 'month-btn';
    b.textContent = m;
    b.setAttribute('aria-pressed','false');
    b.addEventListener('click', () => { selectMonth(i); });
    monthsRow.appendChild(b);
  });
}

function updateMonthButtons() {
  const btns = monthsRow.querySelectorAll('.month-btn');
  btns.forEach((b,i) => b.setAttribute('aria-pressed', (i===selectedMonth).toString()));
}

function selectYear(y) {
  if (!y) return;
  selectedYear = +y;
  yearButton.textContent = String(y);
  // default to January or keep previous month if present
  if (selectedMonth === null) selectedMonth = 0;
  // ensure month exists with articles: if not, pick first month that has articles
  const monthsForYear = grouped[selectedYear] || {};
  if (!monthsForYear[selectedMonth] || monthsForYear[selectedMonth].length === 0) {
    const available = Object.keys(monthsForYear).map(k=>+k).sort((a,b)=>a-b);
    selectedMonth = available.length ? available[0] : 0;
  }
  updateMonthButtons();
  renderMonthList(selectedYear, selectedMonth);
}

function selectMonth(mi) {
  selectedMonth = mi;
  updateMonthButtons();
  if (selectedYear) renderMonthList(selectedYear, selectedMonth);
}

function toggleYearMenu(show) {
  const isOpen = yearList.hidden === false;
  const shouldOpen = (typeof show === 'boolean') ? show : !isOpen;
  yearList.hidden = !shouldOpen;
  yearButton.setAttribute('aria-expanded', String(shouldOpen));
  if (shouldOpen) {
    yearList.focus();
  }
}

// Sidebar click handlers
listEl.addEventListener('click', (ev) => {
  const a = ev.target.closest('a.item');
  if (!a) return;
  ev.preventDefault();
  const filename = a.dataset.filename;
  if (!filename) return;
  if (location.hash.slice(1) !== filename) location.hash = filename;
  loadArticle(filename);
  if (window.matchMedia && window.matchMedia('(max-width:600px)').matches) {
    document.body.classList.remove('show-nav');
    sidebar.classList.remove('expanded');
    peekHandle.setAttribute('aria-expanded','false');
  }
});

yearButton.addEventListener('click', (ev) => { ev.stopPropagation(); toggleYearMenu(); });
document.addEventListener('click', (ev) => { if (!yearList.contains(ev.target) && ev.target !== yearButton) toggleYearMenu(false); });

peekHandle.addEventListener('click', (ev) => {
  ev.stopPropagation();
  const isOpen = document.body.classList.toggle('show-nav');
  if (isOpen) { sidebar.classList.add('expanded'); peekHandle.setAttribute('aria-expanded','true'); }
  else { sidebar.classList.remove('expanded'); peekHandle.setAttribute('aria-expanded','false'); }
});

// keyboard: close with Escape
document.addEventListener('keydown', (ev) => {
  if (ev.key === 'Escape') {
    if (!yearList.hidden) toggleYearMenu(false);
    if (document.body.classList.contains('show-nav')) {
      document.body.classList.remove('show-nav'); sidebar.classList.remove('expanded'); peekHandle.setAttribute('aria-expanded','false'); peekHandle.focus();
    }
  }
});

// Article loading
async function loadArticle(filename) {
  if (!filename) return;
  contentEl.innerHTML = '<p>Loading...</p>';
  const cached = articleCache.get(filename);
  if (cached && cached.html) { contentEl.innerHTML = cached.html; window.scrollTo(0,0); return; }
  try {
    const r = await fetch('responses/' + filename);
    if (!r.ok) { contentEl.innerHTML = '<p>Cannot load file.</p>'; return; }
    const md = await r.text();
    const html = marked.parse(md);
    articleCache.set(filename, { md, html });
    contentEl.innerHTML = html; window.scrollTo(0,0);
  } catch (err) {
    console.error(err); contentEl.innerHTML = '<p>Error loading.</p>';
  }
}

// Load index and build grouped structure
async function loadIndex() {
  try {
    const res = await fetch('index.json');
    if (!res.ok) throw new Error('index.json not found');
    indexData = await res.json();

    // build grouped: year -> monthIndex(0-11) -> [items], sorted desc by date
    grouped = {};
    indexData.forEach(item => {
      const p = parseDateParts(item.date);
      if (!p) return;
      const y = p.year;
      const m = p.month - 1;
      grouped[y] = grouped[y] || {};
      grouped[y][m] = grouped[y][m] || [];
      grouped[y][m].push(item);
    });
    // sort each month descending by date
    Object.keys(grouped).forEach(y => {
      Object.keys(grouped[y]).forEach(m => {
        grouped[y][m].sort((a,b) => (b.date||'').localeCompare(a.date||''));
      });
    });

    years = Object.keys(grouped).map(v=>+v).sort((a,b)=>b-a);
    populateYearList();
    populateMonthsRow();

    // Initial selection — try to respect hash if present
    const initialHash = location.hash ? location.hash.slice(1) : null;
    let initialFilename = initialHash || (indexData[0] && indexData[0].filename);
    if (initialFilename) {
      const found = indexData.find(it=>it.filename===initialFilename);
      if (found) {
        const p = parseDateParts(found.date);
        if (p) { selectedYear = p.year; selectedMonth = p.month - 1; }
      }
    }
    // If nothing found, default to most recent year/month
    if (selectedYear === null) selectedYear = years.length ? years[0] : null;
    if (selectedMonth === null) {
      const monthsForYear = grouped[selectedYear] || {};
      const available = Object.keys(monthsForYear).map(k=>+k).sort((a,b)=>a-b);
      selectedMonth = available.length ? available[0] : 0;
    }

    // update UI and render
    if (selectedYear) {
      yearButton.textContent = String(selectedYear);
      updateMonthButtons();
      renderMonthList(selectedYear, selectedMonth);
    }

    // load article if hash referenced
    if (initialHash) loadArticle(initialHash);

    // hashchange handler
    window.addEventListener('hashchange', () => {
      const f = location.hash.slice(1);
      if (f) loadArticle(f);
    });

  } catch (err) {
    console.error(err); contentEl.innerHTML = '<p>Cannot load index.</p>';
  }
}

loadIndex();
</script>
</body>
</html>
